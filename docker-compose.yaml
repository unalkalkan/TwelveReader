version: "3.9"

services:
  twelvereader:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: twelvereader
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./config/docker.yaml:/app/config/config.yaml:ro
      - twelvereader-data:/app/data
    environment:
      # LLM Provider API Keys
      - TR_LLM_OPENAI_API_KEY=${TR_LLM_OPENAI_API_KEY:-}
      # TTS Provider API Keys
      - TR_TTS_OPENAI_API_KEY=${TR_TTS_OPENAI_API_KEY:-}
      - TR_TTS_QWEN3_API_KEY=${TR_TTS_QWEN3_API_KEY:-}
      # S3 Storage (if using S3 adapter)
      # - TR_STORAGE_S3_ACCESS_KEY_ID=${TR_STORAGE_S3_ACCESS_KEY_ID:-}
      # - TR_STORAGE_S3_SECRET_ACCESS_KEY=${TR_STORAGE_S3_SECRET_ACCESS_KEY:-}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - twelvereader-network

  web-client:
    image: node:22-alpine
    container_name: twelvereader-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./web-client:/app
      - node-modules:/app/node_modules
    working_dir: /app
    command: sh -c "npm install && npx expo export --platform web && npx -y serve dist -l 3000"
    environment:
      - EXPO_PUBLIC_API_URL=http://twelvereader:8080
    depends_on:
      - twelvereader
    networks:
      - twelvereader-network

  # Optional: MinIO for S3-compatible local storage
  # minio:
  #   image: minio/minio:latest
  #   container_name: twelvereader-minio
  #   profiles:
  #     - storage
  #   restart: unless-stopped
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   volumes:
  #     - minio-data:/data
  #   environment:
  #     - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
  #     - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
  #   command: server /data --console-address ":9001"
  #   healthcheck:
  #     test: ["CMD", "mc", "ready", "local"]
  #     interval: 30s
  #     timeout: 5s
  #     retries: 3
  #   networks:
  #     - twelvereader-network

volumes:
  twelvereader-data:
    driver: local
  # minio-data:
  #   driver: local
  node-modules:
    driver: local

networks:
  twelvereader-network:
    driver: bridge
